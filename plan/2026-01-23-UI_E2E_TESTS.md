# UI Tests with Tauri Backend - Implementation Plan

## Goal
Create E2E UI tests that verify the full flow: UI interaction → Tauri command → config persistence → event propagation → UI update. Use a separate config folder with `-test` suffix.

## Proof of Concept
Test changing a client name: verify it calls the Tauri command, writes to config, and the UI reflects the change.

---

## Implementation Steps

### 1. Add Runtime Config Directory Support

**File:** `src-tauri/src/config/paths.rs`

Add `LOCALROUTER_ENV` environment variable support at the start of `config_dir()`:

```rust
pub fn config_dir() -> AppResult<PathBuf> {
    let home = dirs::home_dir()
        .ok_or_else(|| AppError::Config("Could not determine home directory".to_string()))?;

    // Runtime override via environment variable (for testing)
    if let Ok(env_suffix) = std::env::var("LOCALROUTER_ENV") {
        return Ok(home.join(format!(".localrouter-{}", env_suffix)));
    }

    // Existing compile-time logic
    #[cfg(debug_assertions)]
    let dir = home.join(".localrouter-dev");
    #[cfg(not(debug_assertions))]
    let dir = home.join(".localrouter");

    Ok(dir)
}
```

Add test for the new behavior in the `tests` module.

### 2. Install Test Dependencies

**File:** `package.json`

Add to devDependencies:
```json
"@playwright/test": "^1.42.0",
"fs-extra": "^11.2.0",
"yaml": "^2.3.4"
```

Add scripts:
```json
"test:e2e": "playwright test",
"test:e2e:headed": "playwright test --headed",
"test:e2e:debug": "playwright test --debug"
```

### 3. Create Test Directory Structure

```
tests/
└── e2e/
    ├── playwright.config.ts
    ├── global-setup.ts
    ├── global-teardown.ts
    ├── fixtures/
    │   └── test-helpers.ts
    └── specs/
        └── client-name-change.spec.ts
```

### 4. Create Playwright Config

**File:** `tests/e2e/playwright.config.ts`

```typescript
import { defineConfig } from '@playwright/test';
import path from 'path';

export default defineConfig({
  testDir: './specs',
  fullyParallel: false,
  workers: 1,
  timeout: 60000,
  expect: { timeout: 10000 },
  globalSetup: path.join(__dirname, 'global-setup.ts'),
  globalTeardown: path.join(__dirname, 'global-teardown.ts'),
  use: {
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
});
```

### 5. Create Global Setup

**File:** `tests/e2e/global-setup.ts`

- Set `LOCALROUTER_ENV=test` (creates `~/.localrouter-test/`)
- Set `LOCALROUTER_KEYCHAIN=file` (avoid keychain prompts)
- Create clean test config directory
- Build and start Tauri app
- Wait for health endpoint at `http://localhost:3625/health`
- Store process reference for teardown

### 6. Create Global Teardown

**File:** `tests/e2e/global-teardown.ts`

- Kill Tauri process gracefully (SIGTERM, then SIGKILL)
- Remove `~/.localrouter-test/` directory

### 7. Create Test Helpers

**File:** `tests/e2e/fixtures/test-helpers.ts`

- `getConfig()`: Read and parse `~/.localrouter-test/settings.yaml`
- `resetConfig()`: Write default empty config
- `waitForTauriEvent()`: Helper to wait for Tauri events in page context

### 8. Create Client Name Change Test

**File:** `tests/e2e/specs/client-name-change.spec.ts`

```typescript
test('changing client name persists to config and updates UI', async ({ page }) => {
  // 1. Navigate to app
  await page.goto('tauri://localhost');

  // 2. Create a client via UI
  await page.click('text=Clients');
  await page.click('button:has-text("Add Client")');
  await page.fill('input[placeholder*="name"]', 'Original Name');
  await page.click('button:has-text("Create")');

  // 3. Verify client appears
  await expect(page.locator('text=Original Name')).toBeVisible();

  // 4. Read config to get client ID
  const configBefore = await getConfig();
  const client = configBefore.clients.find(c => c.name === 'Original Name');
  expect(client).toBeTruthy();

  // 5. Navigate to client detail and change name
  await page.click('text=Original Name');
  await page.click('text=Settings');
  await page.fill('input[placeholder*="name"]', 'Updated Name');
  await page.click('button:has-text("Save Settings")');

  // 6. Verify UI updated (via clients-changed event)
  await expect(page.locator('h1:has-text("Updated Name")')).toBeVisible();

  // 7. Verify config file updated
  await page.waitForTimeout(500); // Wait for file write
  const configAfter = await getConfig();
  const updatedClient = configAfter.clients.find(c => c.client_id === client.client_id);
  expect(updatedClient.name).toBe('Updated Name');

  // 8. Reload and verify persistence
  await page.reload();
  await page.click('text=Clients');
  await expect(page.locator('text=Updated Name')).toBeVisible();
});
```

---

## Critical Files

| File | Action |
|------|--------|
| `src-tauri/src/config/paths.rs` | Add `LOCALROUTER_ENV` support |
| `package.json` | Add Playwright dependencies |
| `tests/e2e/playwright.config.ts` | Create Playwright config |
| `tests/e2e/global-setup.ts` | Create test setup |
| `tests/e2e/global-teardown.ts` | Create test teardown |
| `tests/e2e/fixtures/test-helpers.ts` | Create helpers |
| `tests/e2e/specs/client-name-change.spec.ts` | Create test |

---

## Verification

1. **Build and run test:**
   ```bash
   npm install
   npx playwright install chromium
   npm run test:e2e
   ```

2. **Verify test isolation:**
   - Check that `~/.localrouter-test/` is created during test
   - Check that it's cleaned up after test
   - Confirm `~/.localrouter-dev/` is untouched

3. **Debug mode:**
   ```bash
   npm run test:e2e:debug
   ```
   Step through the test to verify each assertion.

4. **Verify config persistence:**
   - Run test with `--headed` flag
   - Pause before cleanup to inspect `~/.localrouter-test/settings.yaml`
